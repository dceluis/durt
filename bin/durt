#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative '../lib/durt'
require 'irb'

# Read lines from both file or STDIN
# lines = (ARGV[0] ? IO.readlines(ARGV[0]) : ARGF.readlines).map(&:chomp)

# puts Durt::VERSION

command = ARGV[0]
options = ARGV[1..-1]

def current_project
  Durt::Project.current_project
end

def plugins
  current_project.plugins
end

if command == 'new-project'
  Durt::Project.create_project
elsif command == 'select-project'
  Durt::Project.select!
  current_project.time_tracker_plugins.each(&:switch_project)
elsif command == 'filter'
  plugins.each(&:filter)
elsif command == 'memo'
  bt_plugin = Durt::Project.select_source(current_project)

  bt_plugin.before_choose
  issue = bt_plugin.choose

  tt_plugins = current_project.time_tracker_plugins

  tt_plugins.each { |plugin| plugin.before_enter(issue) }
  tt_plugins.each { |plugin| plugin.enter(issue) }
elsif command == 'stats-all'
  current_project.issues.each(&:puts_stats)
elsif command == 'db'
  system("sqlitebrowser #{Durt::DB_PATH}")
elsif command == 'edit-estimate'
  active_issue = current_project.active_issue

  Durt::EbsPlugin.edit_estimate(active_issue)
elsif command == '-v'
  puts Durt::VERSION
elsif command == 'c'
  ARGV.clear
  IRB.start
else
  const_name = "Durt::Command::#{command.underscore.camelize}"

  const_name.constantize.call if Object.const_defined? const_name
end
